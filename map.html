<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div>
        <div id="map" style="width: 500px; height: 500px;"></div>
        <input type="text" id="search-map" style="width: 400px;margin-bottom:10px">
        <button id="searchCurrentLocation" class="button-primary">Mi ubicación</button>
    </div>
    <script>
        let  map;
        let marker;
        function iniciarMap(){
                var coord = {lat:-12.0529046 ,lng: -77.0253457};
                map = new google.maps.Map(document.getElementById('map'),{
                    zoom: 10,
                    center: coord
                });
                marker = new google.maps.Marker({
                    position: coord,
                    map: map
                });
                const searchMap = document.getElementById('search-map');
                const autocomplete = new google.maps.places.Autocomplete(searchMap);
                // autocomplete.bindTo('bounds',map);
                autocomplete.addListener("place_changed",()=>{
                    const place = autocomplete.getPlace();
                    const {geometry:{viewport,location}} = place;
                    map.setCenter(location);
                    map.setZoom(16);
                    addInfoMap(location);
                })
                //Buscar código postal
        }
        var code_postal;
        async function searchPostalCode(coord){
            geocoder = new google.maps.Geocoder();
            let data ={
                country:'País no encontrada',
                city:'Ciudad no encontrada',
                address:'Dirección no encontrada.',
                postal_code:'Código Postal no encontrada'
            }
            const {results} =await geocoder.geocode({'latLng': coord}, ()=>{});
            console.log(results);
            if (results[0]) {
                data.address =results[0].formatted_address;
                for (j = 0; j < results[0].address_components.length; j++) {
                    if (results[0].address_components[j].types[0] == 'postal_code'){
                        data.postal_code = results[0].address_components[j].short_name;
                    }
                    if (results[0].address_components[j].types[0] == "country") {
                        data.country = results[0].address_components[j].long_name;
                    }
                    if (results[0].address_components[j].types[0] == "locality") {
                        data.city = results[0].address_components[j].long_name;
                    }
                }
            }
            return data;
        }
        // const searchCurrentLocation = document.getElementById('searchCurrentLocation');
        // searchCurrentLocation.addEventListener('click',(e)=>{
        function setCurrentMap(){
            // e.preventDefault();
            searchCurrentLocation.disabled = true;
            searchCurrentLocation.innerHTML = "Buscando..";
            if ("geolocation" in navigator){
                navigator.geolocation.getCurrentPosition(function(position){ 
                    var currentLatitude = position.coords.latitude;
                    var currentLongitude = position.coords.longitude;
                    var currentLocation = { lat: currentLatitude, lng: currentLongitude };
                    marker.setPosition(currentLocation);;
                    map.setCenter(currentLocation);
                    map.setZoom(16);
                    addInfoMap(currentLocation);
                    searchCurrentLocation.innerHTML = 'Mi ubicación';
                    searchCurrentLocation.disabled = false;
                });
            }

        }
        setCurrentMap();
        // })
        async function addInfoMap(currentLocation){
            //Setear información en el mapa
            const {postal_code,country,city,address} =await searchPostalCode(currentLocation);
            var infoWindowHTML = `País: ${country} <br>Ciudad: ${city} <br>Dirección: ${address} <br>Código Postal: ${postal_code}`;
            var infoWindow = new google.maps.InfoWindow({map: map, content: infoWindowHTML});
            infoWindow.setPosition(currentLocation);
            //Setear información en los inputs
            document.getElementById('pais').value = country;
            document.getElementById('ciudad').value = city;
            document.getElementById('direccion').value = address;
            document.getElementById('codPostal').value = postal_code;
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLM2ylauTXO0yLFGOYGRwRUIYNucn4EWc&callback=iniciarMap&libraries=places"></script>
</body>
</html>